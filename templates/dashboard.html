<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF--8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Bot Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #0c0c0c 0%,
          #1a1a2e 50%,
          #16213e 100%
        );
        color: #ffffff;
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        background: linear-gradient(45deg, #00d4ff, #5a67d8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .status-card {
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        text-align: center;
        transition: transform 0.3s ease;
      }

      .status-card:hover {
        transform: translateY(-5px);
      }

      .status-card h3 {
        color: #a0a0a0;
        font-size: 0.9rem;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .status-value {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .profit {
        color: #4ade80;
      }
      .loss {
        color: #f87171;
      }
      .neutral {
        color: #60a5fa;
      }
      .warning {
        color: #fbbf24;
      }

      .charts-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .trade-log {
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        max-height: 400px;
        overflow-y: auto;
      }

      .trade-item {
        padding: 10px;
        margin-bottom: 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border-left: 4px solid;
      }

      .trade-buy {
        border-left-color: #4ade80;
      }
      .trade-sell {
        border-left-color: #f87171;
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }

      .live-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        background: #4ade80;
        border-radius: 50%;
        margin-right: 8px;
      }

      .disclaimer {
        text-align: center;
        padding: 15px;
        margin: 0 0 30px 0;
        background: rgba(251, 191, 36, 0.1);
        color: #fbbf24;
        border-radius: 15px;
        border: 1px solid rgba(251, 191, 36, 0.2);
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>
          <span class="live-indicator pulse"></span>Autonomous Trading Bot
        </h1>
        <p>Real-time Performance Dashboard</p>
        <p id="lastUpdate">Last Update: --</p>
      </div>

      <div class="status-grid">
        <div class="status-card">
          <h3>Bot Status</h3>
          <div id="botStatus" class="status-value neutral">RUNNING</div>
          <div id="uptime">Uptime: 0h 0m</div>
        </div>

        <div class="status-card">
          <h3>Current Position</h3>
          <div id="position" class="status-value neutral">NONE</div>
          <div id="positionSize">Size: --</div>
        </div>

        <div class="status-card">
          <h3>Total P&L</h3>
          <div id="totalPnl" class="status-value neutral">$0.00</div>
          <div id="pnlPct">0.00%</div>
        </div>

        <div class="status-card">
          <h3>Today's Trades</h3>
          <div id="tradesCount" class="status-value neutral">0</div>
          <div id="winRate">Win Rate: --%</div>
        </div>

        <div class="status-card">
          <h3>Current Signal</h3>
          <div id="currentSignal" class="status-value neutral">HOLD</div>
          <div id="signalConfidence">Confidence: --%</div>
        </div>

        <div class="status-card">
          <h3>RSI</h3>
          <div id="rsiValue" class="status-value neutral">--</div>
          <div id="rsiStatus">Neutral</div>
        </div>
      </div>

      <div id="no-data-disclaimer" class="disclaimer" style="display: none">
        The dashboard is waiting for trading activity. Leave the bot running to
        populate P&L and trade history.
      </div>

      <div class="charts-container">
        <div class="chart-card">
          <h3>P&L Chart</h3>
          <canvas id="pnlChart" width="400" height="200"></canvas>
        </div>

        <div class="chart-card">
          <h3>RSI Indicator</h3>
          <canvas id="rsiChart" width="200" height="200"></canvas>
        </div>
      </div>

      <div class="trade-log">
        <h3>Recent Trades</h3>
        <div id="tradesList"></div>
      </div>
    </div>

    <script>
      // Connect to the Socket.IO server run by our Python app
      const socket = io();

      // --- CHART INITIALIZATION ---
      const pnlCtx = document.getElementById("pnlChart").getContext("2d");
      const pnlChart = new Chart(pnlCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Cumulative P&L ($)",
              data: [],
              borderColor: "#4ade80",
              backgroundColor: "rgba(74, 222, 128, 0.1)",
              tension: 0.4,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: "#ffffff" } } },
          scales: {
            x: {
              ticks: { color: "#a0a0a0" },
              grid: { color: "rgba(255, 255, 255, 0.1)" },
            },
            y: {
              ticks: { color: "#a0a0a0" },
              grid: { color: "rgba(255, 255, 255, 0.1)" },
            },
          },
        },
      });

      const rsiCtx = document.getElementById("rsiChart").getContext("2d");
      const rsiChart = new Chart(rsiCtx, {
        type: "doughnut",
        data: {
          labels: ["RSI Value", "Remaining"],
          datasets: [
            {
              data: [50, 50],
              backgroundColor: ["#60a5fa", "rgba(255, 255, 255, 0.1)"],
              borderWidth: 0,
            },
          ],
        },
        options: {
          responsive: true,
          circumference: 180,
          rotation: 270,
          cutout: "80%",
          plugins: { legend: { display: false } },
        },
      });

      let startTime = Date.now();

      // --- REAL-TIME DATA HANDLER ---
      socket.on("update", function (data) {
        console.log("Received real-time update:", data);

        document.getElementById(
          "lastUpdate"
        ).textContent = `Last Update: ${new Date().toLocaleTimeString()}`;
        const uptimeMs = Date.now() - startTime;
        const hours = Math.floor(uptimeMs / 3600000);
        const minutes = Math.floor((uptimeMs % 3600000) / 60000);
        document.getElementById(
          "uptime"
        ).textContent = `Uptime: ${hours}h ${minutes}m`;
        document.getElementById("botStatus").textContent =
          data.bot_status || "RUNNING";

        const pos = data.position;
        const tradeCount = pos ? pos.trade_history.length : 0;
        document.getElementById("tradesCount").textContent = tradeCount;

        const disclaimer = document.getElementById("no-data-disclaimer");
        if (tradeCount > 0) {
          disclaimer.style.display = "none";
        } else {
          disclaimer.style.display = "block";
        }

        if (pos && pos.in_position) {
          const pnl = pos.unrealized_pnl || 0;
          document.getElementById(
            "position"
          ).textContent = `${pos.side} ${pos.symbol}`;
          document.getElementById(
            "positionSize"
          ).textContent = `Size: ${pos.size}`;
          document.getElementById("totalPnl").textContent = `$${pnl.toFixed(
            2
          )}`;
          document.getElementById("totalPnl").className = `status-value ${
            pnl >= 0 ? "profit" : "loss"
          }`;
        } else {
          document.getElementById("position").textContent = "NONE";
          document.getElementById("positionSize").textContent = "Size: --";
          const totalPnl = pos ? pos.total_pnl : 0;
          document.getElementById(
            "totalPnl"
          ).textContent = `$${totalPnl.toFixed(2)}`;
          document.getElementById("totalPnl").className = `status-value ${
            totalPnl >= 0 ? "profit" : "loss"
          }`;
        }

        if (data.analysis) {
          const signal = data.analysis.final_signal;
          const rsi = data.analysis.rsi_value || 50;
          document.getElementById("currentSignal").textContent = signal;
          document.getElementById("rsiValue").textContent = rsi.toFixed(2);
          let rsiStatus = "Neutral";
          if (rsi > 70) rsiStatus = "Overbought";
          else if (rsi < 30) rsiStatus = "Oversold";
          document.getElementById("rsiStatus").textContent = rsiStatus;
          rsiChart.data.datasets[0].data = [rsi, 100 - rsi];
          rsiChart.update("none");
        }

        if (data.pnl_history && data.pnl_history.length > 0) {
          pnlChart.data.labels = data.pnl_history.map((p) =>
            new Date(p.time).toLocaleTimeString()
          );
          pnlChart.data.datasets[0].data = data.pnl_history.map((p) => p.pnl);
          pnlChart.update();
        }

        const tradesList = document.getElementById("tradesList");
        tradesList.innerHTML = "";
        if (pos && pos.trade_history && pos.trade_history.length > 0) {
          pos.trade_history
            .slice(-5)
            .reverse()
            .forEach((trade) => {
              const pnlClass = trade.pnl >= 0 ? "profit" : "loss";
              const pnlSign = trade.pnl >= 0 ? "+" : "";
              const item = document.createElement("div");
              item.className = `trade-item ${
                trade.side === "LONG" ? "trade-buy" : "trade-sell"
              }`;
              item.innerHTML = `
                        <strong>${trade.side}</strong> ${trade.size} ${
                trade.symbol
              }
                        <br><small>${new Date(
                          trade.exit_time
                        ).toLocaleString()} | P&L: <span class="${pnlClass}">${pnlSign}${trade.pnl.toFixed(
                2
              )}</span></small>
                    `;
              tradesList.appendChild(item);
            });
        } else {
          tradesList.innerHTML =
            '<div class="trade-item">No trades executed yet.</div>';
        }
      });
    </script>
  </body>
</html>
